<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opitios Alpaca WebSocket å®æ—¶æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.8;
            margin-bottom: 20px;
        }
        
        .status-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .status-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .status-label {
            font-size: 0.9em;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .status-value {
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .status-online { color: #4CAF50; }
        .status-offline { color: #f44336; }
        .status-connecting { color: #ff9800; }
        
        .data-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .data-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .section-title {
            font-size: 1.4em;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .data-table th,
        .data-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-table th {
            background: rgba(0, 0, 0, 0.2);
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .data-table td {
            font-family: 'Monaco', monospace;
            font-size: 0.85em;
        }
        
        .symbol {
            font-weight: bold;
            color: #64B5F6;
        }
        
        .price-up {
            color: #4CAF50;
        }
        
        .price-down {
            color: #f44336;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .logs-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logs-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', monospace;
            font-size: 0.85em;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .log-timestamp {
            color: #888;
            margin-right: 10px;
        }
        
        .log-info { color: #64B5F6; }
        .log-success { color: #4CAF50; }
        .log-warning { color: #ff9800; }
        .log-error { color: #f44336; }
        
        .info-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .info-item h3 {
            color: #64B5F6;
            margin-bottom: 10px;
        }
        
        .info-item ul {
            list-style: none;
            padding-left: 20px;
        }
        
        .info-item li {
            margin-bottom: 5px;
            position: relative;
        }
        
        .info-item li:before {
            content: "â€¢";
            color: #4CAF50;
            font-weight: bold;
            position: absolute;
            left: -15px;
        }
        
        @media (max-width: 768px) {
            .data-panel {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
    <!-- Add MsgPack library for binary data decoding -->
    <script crossorigin src="https://unpkg.com/@msgpack/msgpack" 
            onload="window.msgpackLoaded = true; console.log('MsgPack library loaded successfully');"
            onerror="window.msgpackLoadError = true; console.error('Failed to load MsgPack library from unpkg'); loadMsgPackFallback();"></script>
    <script>
        // Fallback CDN loader for MsgPack
        function loadMsgPackFallback() {
            console.log('Loading MsgPack from fallback CDN...');
            const script = document.createElement('script');
            script.crossOrigin = 'anonymous';
            script.src = 'https://cdn.jsdelivr.net/npm/@msgpack/msgpack@latest/dist.umd/msgpack.min.js';
            script.onload = function() {
                window.msgpackLoaded = true;
                window.msgpackLoadError = false;
                console.log('MsgPack library loaded successfully from fallback CDN (jsDelivr)');
            };
            script.onerror = function() {
                console.error('Failed to load MsgPack library from fallback CDN (jsDelivr)');
                window.msgpackLoadError = true;
            };
            document.head.appendChild(script);
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Opitios Alpaca WebSocket</h1>
            <div class="subtitle">å®æ—¶è‚¡ç¥¨å’ŒæœŸæƒæ•°æ®æµæµ‹è¯•</div>
            <div class="subtitle">âœ… Alpaca çœŸå®æ•°æ®æµ - æ— æ¨¡æ‹Ÿæ•°æ®</div>
        </div>
        
        <!-- è¿æ¥çŠ¶æ€é¢æ¿ -->
        <div class="status-panel">
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">ç”Ÿäº§ç«¯ç‚¹è¿æ¥</div>
                    <div class="status-value" id="production-status">æœªè¿æ¥</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æµ‹è¯•ç«¯ç‚¹è¿æ¥</div>
                    <div class="status-value" id="test-status">æœªè¿æ¥</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æœŸæƒç«¯ç‚¹è¿æ¥</div>
                    <div class="status-value" id="option-status">æœªè¿æ¥</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ç”Ÿäº§æ¶ˆæ¯æ•°</div>
                    <div class="status-value" id="production-message-count">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æµ‹è¯•æ¶ˆæ¯æ•°</div>
                    <div class="status-value" id="test-message-count">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æœŸæƒæ¶ˆæ¯æ•°</div>
                    <div class="status-value" id="option-message-count">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">è®¢é˜…è‚¡ç¥¨æ•°</div>
                    <div class="status-value" id="stock-count">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">è®¢é˜…æœŸæƒæ•°</div>
                    <div class="status-value" id="option-count">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æœ€åæ›´æ–°</div>
                    <div class="status-value" id="last-update">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æ•°æ®æºå¯¹æ¯”</div>
                    <div class="status-value">ç”Ÿäº§ vs æµ‹è¯•</div>
                </div>
            </div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="button-group">
                <button id="connect-production-btn" onclick="connectProductionWebSocket()">è¿æ¥ç”Ÿäº§ç«¯ç‚¹</button>
                <button id="connect-test-btn" onclick="connectTestWebSocket()">è¿æ¥æµ‹è¯•ç«¯ç‚¹</button>
                <button id="connect-option-btn" onclick="connectOptionWebSocket()">è¿æ¥æœŸæƒç«¯ç‚¹</button>
                <button id="connect-all-btn" onclick="connectAllWebSockets()">è¿æ¥æ‰€æœ‰ç«¯ç‚¹</button>
                <button id="disconnect-production-btn" onclick="disconnectProductionWebSocket()" disabled>æ–­å¼€ç”Ÿäº§è¿æ¥</button>
                <button id="disconnect-test-btn" onclick="disconnectTestWebSocket()" disabled>æ–­å¼€æµ‹è¯•è¿æ¥</button>
                <button id="disconnect-option-btn" onclick="disconnectOptionWebSocket()" disabled>æ–­å¼€æœŸæƒè¿æ¥</button>
                <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                <button onclick="sendPing()">å‘é€å¿ƒè·³åŒ…</button>
                <button onclick="getJWTToken()">è·å–æ¼”ç¤ºJWT</button>
                <button onclick="testMsgPackFunctionality()">æµ‹è¯•MsgPack</button>
                <button onclick="checkMsgPackAvailability()">æ£€æŸ¥MsgPackçŠ¶æ€</button>
            </div>
        </div>
        
        <!-- æ•°æ®æ˜¾ç¤ºé¢æ¿ -->
        <div class="data-panel">
            <!-- ç”Ÿäº§ç«¯ç‚¹è‚¡ç¥¨æ•°æ® -->
            <div class="data-section">
                <div class="section-title">ğŸ“ˆ ç”Ÿäº§ç«¯ç‚¹è‚¡ç¥¨æ•°æ®</div>
                <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 10px;">
                    æ¥æº: æœ¬åœ°ç”Ÿäº§æœåŠ¡å™¨ (localhost:8091)
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>è‚¡ç¥¨ä»£ç </th>
                            <th>ä¹°ä»·</th>
                            <th>å–ä»·</th>
                            <th>æœ€æ–°ä»·</th>
                            <th>æ›´æ–°æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="production-stock-data">
                        <tr>
                            <td colspan="5" style="text-align: center; opacity: 0.6;">ç­‰å¾…è¿æ¥ç”Ÿäº§ç«¯ç‚¹...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- æµ‹è¯•ç«¯ç‚¹è‚¡ç¥¨æ•°æ® -->
            <div class="data-section">
                <div class="section-title">ğŸ§ª æµ‹è¯•ç«¯ç‚¹è‚¡ç¥¨æ•°æ®</div>
                <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 10px;">
                    æ¥æº: Alpaca å®˜æ–¹æµ‹è¯•ç«¯ç‚¹ (stream.data.alpaca.markets)
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>è‚¡ç¥¨ä»£ç </th>
                            <th>ä¹°ä»·</th>
                            <th>å–ä»·</th>
                            <th>æœ€æ–°ä»·</th>
                            <th>æ›´æ–°æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="test-stock-data">
                        <tr>
                            <td colspan="5" style="text-align: center; opacity: 0.6;">ç­‰å¾…è¿æ¥æµ‹è¯•ç«¯ç‚¹...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- æœŸæƒç«¯ç‚¹æ•°æ® -->
            <div class="data-section">
                <div class="section-title">ğŸ“Š æœŸæƒç«¯ç‚¹æ•°æ®</div>
                <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 10px;">
                    æ¥æº: Alpaca æœŸæƒæ•°æ®æµ (v1beta1/indicative)
                </div>
                
                <!-- æœŸæƒè®¢é˜…ç®¡ç† -->
                <div style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                    <div style="margin-bottom: 10px;">
                        <strong>è®¢é˜…ç®¡ç†:</strong>
                        <input type="text" id="new-option-symbol" placeholder="è¾“å…¥æœŸæƒä»£ç  (å¦‚: AAPL250808C00210000)" 
                               style="margin-left: 10px; padding: 5px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 3px;">
                        <button onclick="addOptionSubscription()" style="margin-left: 5px; padding: 5px 10px;">æ·»åŠ è®¢é˜…</button>
                    </div>
                    <div>
                        <strong>å½“å‰è®¢é˜…:</strong> <span id="current-option-subscriptions">æœªè¿æ¥</span>
                    </div>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æœŸæƒä»£ç </th>
                            <th>ç±»å‹</th>
                            <th>ä¹°ä»·</th>
                            <th>å–ä»·</th>
                            <th>æœ€æ–°æˆäº¤ä»·</th>
                            <th>æ›´æ–°æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="option-data">
                        <tr>
                            <td colspan="7" style="text-align: center; opacity: 0.6;">ç­‰å¾…è¿æ¥æœŸæƒç«¯ç‚¹...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- æœŸæƒæ•°æ®å¯¹æ¯”é¢æ¿ -->
        <div class="data-panel">
            <!-- ç”Ÿäº§ç«¯ç‚¹æœŸæƒæ•°æ® -->
            <div class="data-section">
                <div class="section-title">ğŸ“Š ç”Ÿäº§ç«¯ç‚¹æœŸæƒæ•°æ®</div>
                <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 10px;">
                    æ¥æº: æœ¬åœ°ç”Ÿäº§æœåŠ¡å™¨æœŸæƒæ•°æ®
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æœŸæƒä»£ç </th>
                            <th>ä¹°ä»·</th>
                            <th>å–ä»·</th>
                            <th>ç±»å‹</th>
                            <th>æ›´æ–°æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="production-option-data">
                        <tr>
                            <td colspan="5" style="text-align: center; opacity: 0.6;">ç­‰å¾…è¿æ¥ç”Ÿäº§ç«¯ç‚¹...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- æµ‹è¯•ç«¯ç‚¹æœŸæƒæ•°æ® -->
            <div class="data-section">
                <div class="section-title">ğŸ§ª æµ‹è¯•ç«¯ç‚¹æœŸæƒæ•°æ®</div>
                <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 10px;">
                    æ¥æº: Alpaca å®˜æ–¹æµ‹è¯•ç«¯ç‚¹æœŸæƒæ•°æ®
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æœŸæƒä»£ç </th>
                            <th>ä¹°ä»·</th>
                            <th>å–ä»·</th>
                            <th>ç±»å‹</th>
                            <th>æ›´æ–°æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="test-option-data">
                        <tr>
                            <td colspan="5" style="text-align: center; opacity: 0.6;">ç­‰å¾…è¿æ¥æµ‹è¯•ç«¯ç‚¹...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- æ—¥å¿—é¢æ¿ -->
        <div class="logs-panel">
            <div class="section-title">ğŸ“‹ å®æ—¶æ—¥å¿—</div>
            <div class="logs-container" id="logs"></div>
        </div>
        
        <!-- ä¿¡æ¯é¢æ¿ -->
        <div class="info-panel">
            <div class="info-grid">
                <div class="info-item">
                    <h3>WebSocket åŠŸèƒ½ç¡®è®¤</h3>
                    <ul>
                        <li>âœ… Alpaca Paper Trading å®Œå…¨æ”¯æŒ WebSocket</li>
                        <li>âœ… å®æ—¶IEXäº¤æ˜“æ‰€æ•°æ®æµ</li>
                        <li>âœ… è‚¡ç¥¨æŠ¥ä»·å’Œäº¤æ˜“æ•°æ®</li>
                        <li>âœ… æœŸæƒæ•°æ® (å¦‚æœAlpacaæ”¯æŒ)</li>
                        <li>âš ï¸ å…è´¹ç‰ˆé™åˆ¶: 30ä¸ªè‚¡ç¥¨ä»£ç </li>
                        <li>âš ï¸ å•è¿æ¥é™åˆ¶</li>
                    </ul>
                </div>
                <div class="info-item">
                    <h3>æŠ€æœ¯è§„æ ¼</h3>
                    <ul>
                        <li>åè®®: WebSocket over WSS</li>
                        <li>è‚¡ç¥¨æ•°æ®æ ¼å¼: JSON</li>
                        <li>æœŸæƒæ•°æ®æ ¼å¼: MsgPack (äºŒè¿›åˆ¶)</li>
                        <li>æ›´æ–°é¢‘ç‡: å®æ—¶</li>
                        <li>æ•°æ®æº: Alpaca IEX Feed</li>
                        <li>è®¤è¯: API Key</li>
                        <li>æ— Mockæ•°æ®ï¼ŒçœŸå®å¸‚åœºæ•°æ®</li>
                    </ul>
                </div>
                <div class="info-item">
                    <h3>é»˜è®¤æµ‹è¯•æ•°æ®</h3>
                    <ul>
                        <li><strong>æµ‹è¯•ç«¯ç‚¹è‚¡ç¥¨:</strong> FAKEPACA (æµ‹è¯•ä¸“ç”¨)</li>
                        <li><strong>ç”Ÿäº§ç«¯ç‚¹è‚¡ç¥¨:</strong> AAPL, TSLA, NVDA, MRVL, PLTRç­‰</li>
                        <li><strong>é»˜è®¤æœŸæƒä»£ç :</strong></li>
                        <li style="margin-left: 20px;">UNIT250815C00007000, TSLA250808C00310000</li>
                        <li style="margin-left: 20px;">TSLA260918C00750000, CRWV250808C00125000</li>
                        <li style="margin-left: 20px;">MRVL250808C00080000, NVDA250808C00180000</li>
                        <li style="margin-left: 20px;">BRBR250815C00035000, PLTR250808P00170000</li>
                        <li style="margin-left: 20px;">TSLA250808P00300000, FSLR250808P00182500</li>
                        <li style="margin-left: 20px;">AAPL250808C00210000, NVDA250808P00170000</li>
                        <li><strong>æœŸæƒWebSocket:</strong> wss://stream.data.alpaca.markets/v1beta1/indicative</li>
                        <li><strong>æœŸæƒæ•°æ®æ ¼å¼:</strong> MsgPack (äºŒè¿›åˆ¶) âœ… å·²æ”¯æŒ</li>
                        <li><strong>MsgPackåº“çŠ¶æ€:</strong> <span id="msgpack-status">æ£€æµ‹ä¸­...</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let productionWebSocket = null;
        let testWebSocket = null;
        let optionWebSocket = null;
        let productionMessageCount = 0;
        let testMessageCount = 0;
        let optionMessageCount = 0;
        let productionStockData = {};
        let productionOptionData = {};
        let testStockData = {};
        let testOptionData = {};
        let optionData = {};
        
        // é»˜è®¤æœŸæƒè®¢é˜…åˆ—è¡¨
        let defaultOptionSymbols = [
            'UNIT250815C00007000',
            'TSLA250808C00310000', 
            'TSLA260918C00750000',
            'CRWV250808C00125000',
            'MRVL250808C00080000',
            'NVDA250808C00180000',
            'BRBR250815C00035000',
            'PLTR250808P00170000',
            'TSLA250808P00300000',
            'FSLR250808P00182500',
            'AAPL250808C00210000',
            'NVDA250808P00170000'
        ];
        let subscribedOptionSymbols = [...defaultOptionSymbols];
        let jwtToken = null;
        let msgpackAvailable = false;
        
        // Check MsgPack library availability
        function checkMsgPackAvailability() {
            try {
                // Check if library loaded successfully
                if (window.msgpackLoadError) {
                    msgpackAvailable = false;
                    document.getElementById('msgpack-status').innerHTML = '<span style="color: #f44336;">âŒ CDNåŠ è½½å¤±è´¥</span>';
                    log('error', 'MsgPackåº“CDNåŠ è½½å¤±è´¥ - æœŸæƒæ•°æ®è§£ç å°†å¤±è´¥');
                    log('warning', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–CDNå¯ç”¨æ€§');
                    return false;
                }
                
                // Check for MessagePack global variable (from @msgpack/msgpack)
                if (typeof MessagePack !== 'undefined' && MessagePack.encode && MessagePack.decode) {
                    msgpackAvailable = true;
                    document.getElementById('msgpack-status').innerHTML = '<span style="color: #4CAF50;">âœ… å·²åŠ è½½ (MessagePack)</span>';
                    log('success', 'MsgPackåº“åŠ è½½æˆåŠŸ - æ”¯æŒæœŸæƒæ•°æ®è§£ç ');
                    log('info', `MsgPackç‰ˆæœ¬: ${MessagePack.encode ? 'æ”¯æŒç¼–ç ' : ''}${MessagePack.decode ? 'æ”¯æŒè§£ç ' : ''}`);
                    return true;
                }
                
                // Check for msgpack global variable (alternative)
                if (typeof msgpack !== 'undefined' && msgpack.encode && msgpack.decode) {
                    window.MessagePack = msgpack; // Create alias for consistency
                    msgpackAvailable = true;
                    document.getElementById('msgpack-status').innerHTML = '<span style="color: #4CAF50;">âœ… å·²åŠ è½½ (msgpack)</span>';
                    log('success', 'MsgPackåº“åŠ è½½æˆåŠŸ (ä½¿ç”¨msgpackå…¨å±€å˜é‡)');
                    return true;
                }
                
                // Check window.msgpackLoaded flag
                if (window.msgpackLoaded) {
                    log('warning', 'MsgPackåº“å·²æ ‡è®°ä¸ºåŠ è½½ï¼Œä½†å…¨å±€å˜é‡ä¸å¯ç”¨');
                    log('info', 'å¯ç”¨çš„å…¨å±€å˜é‡: ' + Object.keys(window).filter(k => k.toLowerCase().includes('msgpack')).join(', '));
                }
                
            } catch (e) {
                log('error', `MsgPackåº“æ£€æµ‹å¤±è´¥: ${e.message}`);
            }
            
            msgpackAvailable = false;
            document.getElementById('msgpack-status').innerHTML = '<span style="color: #f44336;">âŒ æœªåŠ è½½</span>';
            log('error', 'MsgPackåº“æœªåŠ è½½ - æœŸæƒæ•°æ®è§£ç å°†å¤±è´¥');
            log('info', 'æœŸæƒWebSocketéœ€è¦MsgPackåº“æ¥è§£ç äºŒè¿›åˆ¶æ•°æ®');
            return false;
        }
        
        // WebSocket URLs  
        const productionWsUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'ws://localhost:8091/api/v1/ws/market-data'
            : `ws://${window.location.host}/api/v1/ws/market-data`;
        
        const testWsUrl = 'wss://stream.data.alpaca.markets/v2/test';
        const optionWsUrl = 'wss://stream.data.alpaca.markets/v1beta1/indicative';
        
        function connectProductionWebSocket() {
            if (productionWebSocket && productionWebSocket.readyState === WebSocket.OPEN) {
                log('warning', 'ç”Ÿäº§WebSocketå·²ç»è¿æ¥');
                return;
            }
            
            log('info', `æ­£åœ¨è¿æ¥åˆ°ç”Ÿäº§ç«¯ç‚¹: ${productionWsUrl}`);
            updateConnectionStatus('production', 'connecting');
            
            productionWebSocket = new WebSocket(productionWsUrl);
            
            productionWebSocket.onopen = function(event) {
                log('success', 'ç”Ÿäº§WebSocketè¿æ¥æˆåŠŸ!');
                updateConnectionStatus('production', 'online');
                document.getElementById('connect-production-btn').disabled = true;
                document.getElementById('disconnect-production-btn').disabled = false;
                
                // Auto-subscribe to stock data only (options use separate WebSocket)
                setTimeout(() => {
                    const stockSymbols = ['AAPL', 'TSLA', 'NVDA', 'MRVL', 'PLTR', 'UNIT', 'CRWV', 'BRBR', 'FSLR'];
                    
                    const subscribeMessage = {
                        action: 'subscribe',
                        symbols: stockSymbols,
                        data_types: ['quotes', 'trades', 'bars']
                    };
                    
                    productionWebSocket.send(JSON.stringify(subscribeMessage));
                    log('info', `[ç”Ÿäº§] å‘é€è‚¡ç¥¨è®¢é˜…: ${stockSymbols.join(', ')}`);
                }, 500);
            };
            
            productionWebSocket.onmessage = function(event) {
                productionMessageCount++;
                document.getElementById('production-message-count').textContent = productionMessageCount;
                
                try {
                    const data = JSON.parse(event.data);
                    handleProductionWebSocketMessage(data);
                } catch (e) {
                    log('error', `è§£æç”Ÿäº§æ¶ˆæ¯å¤±è´¥: ${e.message}`);
                }
            };
            
            productionWebSocket.onclose = function(event) {
                log('warning', `ç”Ÿäº§WebSocketè¿æ¥å…³é—­: ${event.code} - ${event.reason}`);
                updateConnectionStatus('production', 'offline');
                document.getElementById('connect-production-btn').disabled = false;
                document.getElementById('disconnect-production-btn').disabled = true;
            };
            
            productionWebSocket.onerror = function(error) {
                log('error', `ç”Ÿäº§WebSocketé”™è¯¯: ${error}`);
                updateConnectionStatus('production', 'offline');
            };
        }
        
        async function connectTestWebSocket() {
            if (testWebSocket && testWebSocket.readyState === WebSocket.OPEN) {
                log('warning', 'æµ‹è¯•WebSocketå·²ç»è¿æ¥');
                return;
            }
            
            log('info', `æ­£åœ¨è¿æ¥åˆ°æµ‹è¯•ç«¯ç‚¹: ${testWsUrl}`);
            updateConnectionStatus('test', 'connecting');
            
            // Get real API credentials first
            let credentials = null;
            try {
                log('info', '[æµ‹è¯•] æ­£åœ¨è·å–çœŸå®APIå‡­æ®...');
                const response = await fetch('http://localhost:8091/api/v1/auth/alpaca-credentials');
                if (response.ok) {
                    credentials = await response.json();
                    log('success', `[æµ‹è¯•] è·å–åˆ°çœŸå®APIå‡­æ®: ${credentials.account_name}`);
                } else {
                    log('error', '[æµ‹è¯•] è·å–APIå‡­æ®å¤±è´¥ï¼Œä½¿ç”¨æµ‹è¯•å‡­æ®');
                }
            } catch (error) {
                log('error', `[æµ‹è¯•] è·å–APIå‡­æ®é”™è¯¯: ${error.message}`);
            }
            
            testWebSocket = new WebSocket(testWsUrl);
            
            testWebSocket.onopen = function(event) {
                log('success', 'æµ‹è¯•WebSocketè¿æ¥æˆåŠŸ!');
                updateConnectionStatus('test', 'online');
                document.getElementById('connect-test-btn').disabled = true;
                document.getElementById('disconnect-test-btn').disabled = false;
                
                // Send authentication to Alpaca test endpoint with real credentials
                const authMessage = {
                    action: 'auth',
                    key: credentials ? credentials.api_key : 'test_api_key',
                    secret: credentials ? credentials.secret_key : 'test_secret_key'
                };
                testWebSocket.send(JSON.stringify(authMessage));
                log('info', `[æµ‹è¯•] å‘é€è®¤è¯æ¶ˆæ¯ - ä½¿ç”¨${credentials ? 'çœŸå®' : 'æµ‹è¯•'}å‡­æ®`);
                
                // Subscribe to test data - MUST use FAKEPACA for test endpoint
                setTimeout(() => {
                    const subscribeMessage = {
                        action: 'subscribe',
                        trades: ['FAKEPACA'],
                        quotes: ['FAKEPACA'],
                        bars: ['FAKEPACA']
                    };
                    testWebSocket.send(JSON.stringify(subscribeMessage));
                    log('info', '[æµ‹è¯•] å‘é€è®¢é˜…æ¶ˆæ¯: FAKEPACA (æµ‹è¯•ç«¯ç‚¹ä¸“ç”¨è‚¡ç¥¨ä»£ç )');
                }, 1000);
            };
            
            testWebSocket.onmessage = function(event) {
                testMessageCount++;
                document.getElementById('test-message-count').textContent = testMessageCount;
                
                try {
                    const data = JSON.parse(event.data);
                    handleTestWebSocketMessage(data);
                } catch (e) {
                    log('error', `è§£ææµ‹è¯•æ¶ˆæ¯å¤±è´¥: ${e.message}`);
                }
            };
            
            testWebSocket.onclose = function(event) {
                log('warning', `æµ‹è¯•WebSocketè¿æ¥å…³é—­: ${event.code} - ${event.reason}`);
                updateConnectionStatus('test', 'offline');
                document.getElementById('connect-test-btn').disabled = false;
                document.getElementById('disconnect-test-btn').disabled = true;
            };
            
            testWebSocket.onerror = function(error) {
                log('error', `æµ‹è¯•WebSocketé”™è¯¯: ${error}`);
                updateConnectionStatus('test', 'offline');
            };
        }
        
        async function connectBothWebSockets() {
            connectProductionWebSocket();
            setTimeout(async () => await connectTestWebSocket(), 1000);
        }
        
        function disconnectProductionWebSocket() {
            if (productionWebSocket) {
                productionWebSocket.close();
                log('info', 'ç”Ÿäº§WebSocketè¿æ¥å·²æ–­å¼€');
            }
        }
        
        function disconnectTestWebSocket() {
            if (testWebSocket) {
                testWebSocket.close();
                log('info', 'æµ‹è¯•WebSocketè¿æ¥å·²æ–­å¼€');
            }
        }
        
        async function connectOptionWebSocket() {
            if (optionWebSocket && optionWebSocket.readyState === WebSocket.OPEN) {
                log('warning', 'æœŸæƒWebSocketå·²ç»è¿æ¥');
                return;
            }
            
            try {
                // Get real API credentials for option WebSocket
                const response = await fetch('/api/v1/auth/alpaca-credentials');
                if (!response.ok) {
                    log('error', 'æ— æ³•è·å–APIå‡­æ®');
                    return;
                }
                const credentials = await response.json();
                
                log('info', `æ­£åœ¨è¿æ¥åˆ°æœŸæƒç«¯ç‚¹: ${optionWsUrl}`);
                updateConnectionStatus('option', 'connecting');
                
                // Note: Option WebSocket only supports msgpack format, not JSON
                // For demonstration, we'll show connection attempt
                optionWebSocket = new WebSocket(optionWsUrl);
                
                optionWebSocket.onopen = function(event) {
                    log('success', 'æœŸæƒWebSocketè¿æ¥æˆåŠŸ!');
                    updateConnectionStatus('option', 'online');
                    document.getElementById('connect-option-btn').disabled = true;
                    document.getElementById('disconnect-option-btn').disabled = false;
                    
                    // Send authentication using MsgPack format
                    const authMessage = {
                        action: 'auth',
                        key: credentials.api_key,
                        secret: credentials.secret_key
                    };
                    
                    try {
                        if (msgpackAvailable) {
                            const encodedAuth = MessagePack.encode(authMessage);
                            optionWebSocket.send(encodedAuth);
                            log('success', '[æœŸæƒ] å‘é€MsgPackæ ¼å¼è®¤è¯æ¶ˆæ¯');
                        } else {
                            // Fallback to JSON (will likely fail but shows the attempt)
                            optionWebSocket.send(JSON.stringify(authMessage));
                            log('warning', '[æœŸæƒ] MsgPackä¸å¯ç”¨ï¼Œä½¿ç”¨JSONæ ¼å¼ï¼ˆå¯èƒ½å¤±è´¥ï¼‰');
                        }
                    } catch (encodeError) {
                        log('error', `[æœŸæƒ] è®¤è¯æ¶ˆæ¯ç¼–ç å¤±è´¥: ${encodeError.message}`);
                    }
                    
                    // Send initial option subscriptions using MsgPack
                    setTimeout(() => {
                        if (subscribedOptionSymbols.length > 0) {
                            const subscribeMessage = {
                                action: 'subscribe',
                                trades: subscribedOptionSymbols,
                                quotes: subscribedOptionSymbols
                            };
                            
                            try {
                                if (msgpackAvailable) {
                                    const encodedSubscribe = MessagePack.encode(subscribeMessage);
                                    optionWebSocket.send(encodedSubscribe);
                                    log('success', `[æœŸæƒ] å‘é€MsgPackæ ¼å¼åˆå§‹è®¢é˜…: ${subscribedOptionSymbols.length}ä¸ªæœŸæƒ`);
                                } else {
                                    optionWebSocket.send(JSON.stringify(subscribeMessage));
                                    log('warning', `[æœŸæƒ] ä½¿ç”¨JSONæ ¼å¼åˆå§‹è®¢é˜… (å¯èƒ½å¤±è´¥)`);
                                }
                            } catch (encodeError) {
                                log('error', `[æœŸæƒ] åˆå§‹è®¢é˜…ç¼–ç å¤±è´¥: ${encodeError.message}`);
                            }
                        }
                        
                        updateOptionSubscriptionDisplay();
                    }, 1000);
                };
                
                optionWebSocket.onmessage = function(event) {
                    optionMessageCount++;
                    document.getElementById('option-message-count').textContent = optionMessageCount;
                    
                    try {
                        // Handle MsgPack binary data from option endpoint
                        if (event.data instanceof Blob) {
                            // Binary data (Blob) - convert to ArrayBuffer for MsgPack
                            log('info', `[æœŸæƒ] æ”¶åˆ°äºŒè¿›åˆ¶æ•°æ® (Blob): ${event.data.size} bytes`);
                            
                            event.data.arrayBuffer().then(buffer => {
                                try {
                                    if (!msgpackAvailable) {
                                        log('error', '[æœŸæƒ] MsgPackåº“ä¸å¯ç”¨ï¼Œæ— æ³•è§£ç äºŒè¿›åˆ¶æ•°æ®');
                                        log('warning', '[æœŸæƒ] è¯·ç‚¹å‡»"æ£€æŸ¥MsgPackçŠ¶æ€"æŒ‰é’®è¯Šæ–­é—®é¢˜');
                                        return;
                                    }
                                    
                                    const uint8Array = new Uint8Array(buffer);
                                    log('info', `[æœŸæƒ] å‡†å¤‡è§£ç  ${uint8Array.length} bytes æ•°æ®`);
                                    
                                    const data = MessagePack.decode(uint8Array);
                                    const dataPreview = JSON.stringify(data).substring(0, 200);
                                    log('success', `[æœŸæƒ] MsgPackè§£ç æˆåŠŸ: ${dataPreview}${dataPreview.length >= 200 ? '...' : ''}`);
                                    handleOptionWebSocketMessage(data);
                                } catch (msgpackError) {
                                    log('error', `[æœŸæƒ] MsgPackè§£ç å¤±è´¥: ${msgpackError.message}`);
                                    log('info', `[æœŸæƒ] æ•°æ®é•¿åº¦: ${buffer.byteLength} bytes`);
                                    
                                    // Show hex dump of first few bytes for debugging
                                    const debugArray = new Uint8Array(buffer, 0, Math.min(16, buffer.byteLength));
                                    const hexDump = Array.from(debugArray).map(b => b.toString(16).padStart(2, '0')).join(' ');
                                    log('info', `[æœŸæƒ] å‰16å­—èŠ‚åå…­è¿›åˆ¶: ${hexDump}`);
                                }
                            }).catch(blobError => {
                                log('error', `[æœŸæƒ] Blobè½¬ArrayBufferå¤±è´¥: ${blobError.message}`);
                            });
                        } else if (event.data instanceof ArrayBuffer) {
                            // Direct ArrayBuffer data
                            log('info', `[æœŸæƒ] æ”¶åˆ°äºŒè¿›åˆ¶æ•°æ® (ArrayBuffer): ${event.data.byteLength} bytes`);
                            
                            try {
                                if (!msgpackAvailable) {
                                    log('error', '[æœŸæƒ] MsgPackåº“ä¸å¯ç”¨ï¼Œæ— æ³•è§£ç äºŒè¿›åˆ¶æ•°æ®');
                                    log('warning', '[æœŸæƒ] è¯·ç‚¹å‡»"æ£€æŸ¥MsgPackçŠ¶æ€"æŒ‰é’®è¯Šæ–­é—®é¢˜');
                                    return;
                                }
                                
                                const uint8Array = new Uint8Array(event.data);
                                log('info', `[æœŸæƒ] å‡†å¤‡è§£ç  ${uint8Array.length} bytes æ•°æ®`);
                                
                                const data = MessagePack.decode(uint8Array);
                                const dataPreview = JSON.stringify(data).substring(0, 200);
                                log('success', `[æœŸæƒ] MsgPackè§£ç æˆåŠŸ: ${dataPreview}${dataPreview.length >= 200 ? '...' : ''}`);
                                handleOptionWebSocketMessage(data);
                            } catch (msgpackError) {
                                log('error', `[æœŸæƒ] MsgPackè§£ç å¤±è´¥: ${msgpackError.message}`);
                                log('info', `[æœŸæƒ] æ•°æ®é•¿åº¦: ${event.data.byteLength} bytes`);
                                
                                // Show hex dump of first few bytes for debugging
                                const debugArray = new Uint8Array(event.data, 0, Math.min(16, event.data.byteLength));
                                const hexDump = Array.from(debugArray).map(b => b.toString(16).padStart(2, '0')).join(' ');
                                log('info', `[æœŸæƒ] å‰16å­—èŠ‚åå…­è¿›åˆ¶: ${hexDump}`);
                            }
                        } else if (typeof event.data === 'string') {
                            // Fallback: Try JSON parsing for non-binary data
                            try {
                                const data = JSON.parse(event.data);
                                log('info', `[æœŸæƒ] æ”¶åˆ°JSONæ¶ˆæ¯: ${event.data}`);
                                handleOptionWebSocketMessage(data);
                            } catch (jsonError) {
                                log('error', `[æœŸæƒ] JSONè§£æå¤±è´¥: ${jsonError.message}`);
                                log('info', `[æœŸæƒ] åŸå§‹æ¶ˆæ¯: ${event.data}`);
                            }
                        } else {
                            log('warning', `[æœŸæƒ] æœªçŸ¥æ•°æ®æ ¼å¼: ${typeof event.data}`);
                        }
                    } catch (e) {
                        log('error', `[æœŸæƒ] æ¶ˆæ¯å¤„ç†å¤±è´¥: ${e.message}`);
                    }
                };
                
                optionWebSocket.onclose = function(event) {
                    log('warning', `æœŸæƒWebSocketè¿æ¥å…³é—­: ${event.code} - ${event.reason}`);
                    updateConnectionStatus('option', 'offline');
                    document.getElementById('connect-option-btn').disabled = false;
                    document.getElementById('disconnect-option-btn').disabled = true;
                };
                
                optionWebSocket.onerror = function(error) {
                    log('error', `æœŸæƒWebSocketé”™è¯¯: ${error}`);
                    updateConnectionStatus('option', 'offline');
                };
                
            } catch (error) {
                log('error', `æœŸæƒWebSocketè¿æ¥é”™è¯¯: ${error.message}`);
                updateConnectionStatus('option', 'offline');
            }
        }
        
        function disconnectOptionWebSocket() {
            if (optionWebSocket) {
                optionWebSocket.close();
                log('info', 'æœŸæƒWebSocketè¿æ¥å·²æ–­å¼€');
                updateConnectionStatus('option', 'offline');
            }
        }
        
        function connectAllWebSockets() {
            connectProductionWebSocket();
            setTimeout(async () => await connectTestWebSocket(), 1000);
            setTimeout(async () => await connectOptionWebSocket(), 2000);
        }
        
        function addOptionSubscription() {
            const input = document.getElementById('new-option-symbol');
            const symbol = input.value.trim().toUpperCase();
            
            if (!symbol) {
                log('warning', 'è¯·è¾“å…¥æœŸæƒä»£ç ');
                return;
            }
            
            if (subscribedOptionSymbols.includes(symbol)) {
                log('warning', `æœŸæƒ ${symbol} å·²åœ¨è®¢é˜…åˆ—è¡¨ä¸­`);
                return;
            }
            
            subscribedOptionSymbols.push(symbol);
            log('info', `æ·»åŠ æœŸæƒè®¢é˜…: ${symbol}`);
            
            // If connected, send subscription using MsgPack
            if (optionWebSocket && optionWebSocket.readyState === WebSocket.OPEN) {
                const subscribeMessage = {
                    action: 'subscribe',
                    trades: [symbol],
                    quotes: [symbol]
                };
                
                try {
                    if (msgpackAvailable) {
                        const encodedSubscribe = MessagePack.encode(subscribeMessage);
                        optionWebSocket.send(encodedSubscribe);
                        log('info', `[æœŸæƒ] å‘é€MsgPackæ ¼å¼è®¢é˜…: ${symbol}`);
                    } else {
                        optionWebSocket.send(JSON.stringify(subscribeMessage));
                        log('warning', `[æœŸæƒ] ä½¿ç”¨JSONæ ¼å¼è®¢é˜… ${symbol} (å¯èƒ½å¤±è´¥)`);
                    }
                } catch (encodeError) {
                    log('error', `[æœŸæƒ] è®¢é˜…æ¶ˆæ¯ç¼–ç å¤±è´¥: ${encodeError.message}`);
                }
            }
            
            updateOptionSubscriptionDisplay();
            input.value = '';
        }
        
        function removeOptionSubscription(symbol) {
            const index = subscribedOptionSymbols.indexOf(symbol);
            if (index > -1) {
                subscribedOptionSymbols.splice(index, 1);
                log('info', `ç§»é™¤æœŸæƒè®¢é˜…: ${symbol}`);
                
                // If connected, send unsubscription using MsgPack
                if (optionWebSocket && optionWebSocket.readyState === WebSocket.OPEN) {
                    const unsubscribeMessage = {
                        action: 'unsubscribe',
                        trades: [symbol],
                        quotes: [symbol]
                    };
                    
                    try {
                        if (msgpackAvailable) {
                            const encodedUnsubscribe = MessagePack.encode(unsubscribeMessage);
                            optionWebSocket.send(encodedUnsubscribe);
                            log('info', `[æœŸæƒ] å‘é€MsgPackæ ¼å¼å–æ¶ˆè®¢é˜…: ${symbol}`);
                        } else {
                            optionWebSocket.send(JSON.stringify(unsubscribeMessage));
                            log('warning', `[æœŸæƒ] ä½¿ç”¨JSONæ ¼å¼å–æ¶ˆè®¢é˜… ${symbol} (å¯èƒ½å¤±è´¥)`);
                        }
                    } catch (encodeError) {
                        log('error', `[æœŸæƒ] å–æ¶ˆè®¢é˜…æ¶ˆæ¯ç¼–ç å¤±è´¥: ${encodeError.message}`);
                    }
                }
                
                // Remove from data and UI
                delete optionData[symbol];
                updateOptionTable();
                updateOptionSubscriptionDisplay();
            }
        }
        
        function updateOptionSubscriptionDisplay() {
            const subscriptionSpan = document.getElementById('current-option-subscriptions');
            if (subscribedOptionSymbols.length === 0) {
                subscriptionSpan.textContent = 'æ— è®¢é˜…';
            } else {
                subscriptionSpan.textContent = subscribedOptionSymbols.slice(0, 3).join(', ') + 
                    (subscribedOptionSymbols.length > 3 ? `... (${subscribedOptionSymbols.length}ä¸ª)` : '');
            }
        }
        
        function handleOptionWebSocketMessage(data) {
            // Enhanced message handling with better error recovery
            try {
                if (Array.isArray(data)) {
                    log('info', `[æœŸæƒ] å¤„ç†æ¶ˆæ¯æ•°ç»„ï¼ŒåŒ…å« ${data.length} æ¡æ¶ˆæ¯`);
                    data.forEach((item, index) => {
                        try {
                            processOptionMessage(item);
                        } catch (itemError) {
                            log('error', `[æœŸæƒ] å¤„ç†ç¬¬ ${index + 1} æ¡æ¶ˆæ¯å¤±è´¥: ${itemError.message}`);
                        }
                    });
                } else if (data && typeof data === 'object') {
                    processOptionMessage(data);
                } else {
                    log('warning', `[æœŸæƒ] æ”¶åˆ°éå¯¹è±¡æ•°æ®: ${typeof data}`);
                }
                updateOptionTable();
            } catch (error) {
                log('error', `[æœŸæƒ] æ¶ˆæ¯å¤„ç†å¤±è´¥: ${error.message}`);
            }
        }
        
        function processOptionMessage(item) {
            try {
                // Handle different message types from Alpaca option endpoint
                const messageType = item.T || item.action || item.type;
                const symbol = item.S || item.symbol;
                
                if (!messageType) {
                    log('info', `[æœŸæƒ] æ”¶åˆ°ç³»ç»Ÿæ¶ˆæ¯: ${JSON.stringify(item)}`);
                    return;
                }
                
                if (!symbol && (messageType === 'q' || messageType === 't')) {
                    log('warning', `[æœŸæƒ] ${messageType} æ¶ˆæ¯ç¼ºå°‘è‚¡ç¥¨ä»£ç `);
                    return;
                }
                
                switch (messageType) {
                    case 'success':
                        log('success', `[æœŸæƒ] ${item.msg || 'è®¤è¯/è®¢é˜…æˆåŠŸ'}`);
                        break;
                        
                    case 'subscription':
                        log('info', `[æœŸæƒ] è®¢é˜…ç¡®è®¤: ${JSON.stringify(item)}`);
                        break;
                        
                    case 'error':
                        log('error', `[æœŸæƒ] æœåŠ¡å™¨é”™è¯¯: ${item.msg || item.message || JSON.stringify(item)}`);
                        break;
                        
                    case 'q': // Quote
                        if (!optionData[symbol]) {
                            optionData[symbol] = {};
                        }
                        optionData[symbol] = {
                            ...optionData[symbol],
                            bid_price: item.bp,
                            ask_price: item.ap,
                            bid_size: item.bs,
                            ask_size: item.as,
                            quote_timestamp: item.t,
                            last_update: Date.now()
                        };
                        log('info', `[æœŸæƒ] æŠ¥ä»·æ›´æ–° ${symbol}: Bid=$${item.bp}, Ask=$${item.ap}`);
                        break;
                        
                    case 't': // Trade
                        if (!optionData[symbol]) {
                            optionData[symbol] = {};
                        }
                        optionData[symbol] = {
                            ...optionData[symbol],
                            last_price: item.p,
                            last_size: item.s,
                            trade_timestamp: item.t,
                            last_update: Date.now()
                        };
                        log('success', `[æœŸæƒ] äº¤æ˜“æ•°æ® ${symbol}: Price=$${item.p}, Size=${item.s}`);
                        break;
                        
                    default:
                        log('info', `[æœŸæƒ] æœªçŸ¥æ¶ˆæ¯ç±»å‹ ${messageType}: ${JSON.stringify(item)}`);
                }
            } catch (error) {
                log('error', `[æœŸæƒ] å¤„ç†æ¶ˆæ¯é¡¹å¤±è´¥: ${error.message}`);
                log('info', `[æœŸæƒ] é—®é¢˜æ¶ˆæ¯: ${JSON.stringify(item)}`);
            }
        }
        
        function updateOptionTable() {
            const tbody = document.getElementById('option-data');
            
            if (Object.keys(optionData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; opacity: 0.6;">ç­‰å¾…æœŸæƒæ•°æ®...</td></tr>';
                return;
            }
            
            const rows = Object.entries(optionData).map(([symbol, data]) => {
                const time = data.last_update ? new Date(data.last_update).toLocaleTimeString() : '-';
                const optionType = symbol.includes('C') ? 'Call' : 'Put';
                const bidPrice = data.bid_price ? `$${data.bid_price.toFixed(2)}` : '-';
                const askPrice = data.ask_price ? `$${data.ask_price.toFixed(2)}` : '-';
                const lastPrice = data.last_price ? `$${data.last_price.toFixed(2)}` : '-';
                
                return `
                    <tr>
                        <td class="symbol">${symbol}</td>
                        <td>${optionType}</td>
                        <td class="price-up">${bidPrice}</td>
                        <td class="price-down">${askPrice}</td>
                        <td class="price-neutral">${lastPrice}</td>
                        <td>${time}</td>
                        <td><button onclick="removeOptionSubscription('${symbol}')" style="padding: 2px 6px; font-size: 0.8em;">ç§»é™¤</button></td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }
        
        function handleProductionWebSocketMessage(data) {
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            
            switch (data.type) {
                case 'welcome':
                    log('success', `[ç”Ÿäº§] æ¬¢è¿æ¶ˆæ¯: ${data.message}`);
                    if (data.default_stocks) log('info', `[ç”Ÿäº§] é»˜è®¤è‚¡ç¥¨: ${data.default_stocks.join(', ')}`);
                    if (data.default_options) log('info', `[ç”Ÿäº§] é»˜è®¤æœŸæƒ: ${data.default_options.join(', ')}`);
                    break;
                    
                case 'subscription':
                    log('info', `[ç”Ÿäº§] è®¢é˜…ç¡®è®¤: ${data.message}`);
                    updateSubscriptionCounts(data.subscribed_symbols);
                    break;
                    
                case 'quote':
                    handleProductionQuoteData(data);
                    break;
                    
                case 'trade':
                    handleProductionTradeData(data);
                    break;
                    
                case 'pong':
                    log('info', `[ç”Ÿäº§] å¿ƒè·³å“åº”: ${data.timestamp}`);
                    break;
                    
                default:
                    log('info', `[ç”Ÿäº§] æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data)}`);
            }
        }
        
        function handleTestWebSocketMessage(data) {
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            
            // Handle Alpaca test endpoint messages
            if (Array.isArray(data)) {
                // Handle message array
                data.forEach(message => {
                    handleSingleTestMessage(message);
                });
            } else {
                handleSingleTestMessage(data);
            }
        }
        
        function handleSingleTestMessage(data) {
            switch (data.T) {
                case 'success':
                    log('success', `[æµ‹è¯•] è®¤è¯æˆåŠŸ: ${data.msg}`);
                    break;
                    
                case 'subscription':
                    log('info', `[æµ‹è¯•] è®¢é˜…ç¡®è®¤: ${JSON.stringify(data)}`);
                    break;
                    
                case 'q':  // Quote data
                    handleTestQuoteData(data);
                    break;
                    
                case 't':  // Trade data
                    handleTestTradeData(data);
                    break;
                    
                case 'error':
                    log('error', `[æµ‹è¯•] é”™è¯¯: ${data.msg}`);
                    break;
                    
                default:
                    log('info', `[æµ‹è¯•] æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data)}`);
            }
        }
        
        function handleProductionQuoteData(data) {
            const symbol = data.symbol;
            const isOption = symbol.length > 10;
            
            if (isOption) {
                productionOptionData[symbol] = data;
                updateProductionOptionTable();
                log('info', `[ç”Ÿäº§] æœŸæƒæŠ¥ä»· ${symbol}: Bid=${data.bid_price}, Ask=${data.ask_price}`);
            } else {
                productionStockData[symbol] = data;
                updateProductionStockTable();
                log('info', `[ç”Ÿäº§] è‚¡ç¥¨æŠ¥ä»· ${symbol}: Bid=${data.bid_price}, Ask=${data.ask_price}`);
            }
        }
        
        function handleProductionTradeData(data) {
            const symbol = data.symbol;
            log('success', `[ç”Ÿäº§] äº¤æ˜“æ•°æ® ${symbol}: Price=${data.price}, Size=${data.size}`);
            
            // æ›´æ–°æœ€æ–°ä»·æ ¼
            if (productionStockData[symbol]) {
                productionStockData[symbol].last_price = data.price;
                updateProductionStockTable();
            }
        }
        
        function handleTestQuoteData(data) {
            const symbol = data.S;  // Alpaca uses 'S' for symbol
            const quote = {
                symbol: symbol,
                bid_price: data.bp,
                ask_price: data.ap,
                bid_size: data.bs,
                ask_size: data.as,
                timestamp: data.t
            };
            
            testStockData[symbol] = quote;
            updateTestStockTable();
            log('info', `[æµ‹è¯•] è‚¡ç¥¨æŠ¥ä»· ${symbol}: Bid=${data.bp}, Ask=${data.ap}`);
        }
        
        function handleTestTradeData(data) {
            const symbol = data.S;
            log('success', `[æµ‹è¯•] äº¤æ˜“æ•°æ® ${symbol}: Price=${data.p}, Size=${data.s}`);
            
            // æ›´æ–°æœ€æ–°ä»·æ ¼
            if (testStockData[symbol]) {
                testStockData[symbol].last_price = data.p;
                updateTestStockTable();
            }
        }
        
        function updateProductionStockTable() {
            const tbody = document.getElementById('production-stock-data');
            const rows = Object.entries(productionStockData).map(([symbol, data]) => {
                const time = new Date(data.timestamp).toLocaleTimeString();
                return `
                    <tr>
                        <td class="symbol">${symbol}</td>
                        <td class="price-up">${data.bid_price || '-'}</td>
                        <td class="price-down">${data.ask_price || '-'}</td>
                        <td>${data.last_price || '-'}</td>
                        <td>${time}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rows.length > 0 ? rows.join('') : 
                '<tr><td colspan="5" style="text-align: center; opacity: 0.6;">æš‚æ— ç”Ÿäº§è‚¡ç¥¨æ•°æ®</td></tr>';
        }
        
        function updateTestStockTable() {
            const tbody = document.getElementById('test-stock-data');
            const rows = Object.entries(testStockData).map(([symbol, data]) => {
                const time = data.timestamp ? new Date(data.timestamp / 1000000).toLocaleTimeString() : '-';
                return `
                    <tr>
                        <td class="symbol">${symbol}</td>
                        <td class="price-up">${data.bid_price || '-'}</td>
                        <td class="price-down">${data.ask_price || '-'}</td>
                        <td>${data.last_price || '-'}</td>
                        <td>${time}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rows.length > 0 ? rows.join('') : 
                '<tr><td colspan="5" style="text-align: center; opacity: 0.6;">æš‚æ— æµ‹è¯•è‚¡ç¥¨æ•°æ®</td></tr>';
        }
        
        function updateProductionOptionTable() {
            const tbody = document.getElementById('production-option-data');
            const rows = Object.entries(productionOptionData).map(([symbol, data]) => {
                const time = new Date(data.timestamp).toLocaleTimeString();
                const optionType = symbol.includes('C') ? 'Call' : 'Put';
                return `
                    <tr>
                        <td class="symbol">${symbol}</td>
                        <td class="price-up">${data.bid_price || '-'}</td>
                        <td class="price-down">${data.ask_price || '-'}</td>
                        <td>${optionType}</td>
                        <td>${time}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rows.length > 0 ? rows.join('') : 
                '<tr><td colspan="5" style="text-align: center; opacity: 0.6;">æš‚æ— ç”Ÿäº§æœŸæƒæ•°æ®</td></tr>';
        }
        
        function updateTestOptionTable() {
            const tbody = document.getElementById('test-option-data');
            const rows = Object.entries(testOptionData).map(([symbol, data]) => {
                const time = data.timestamp ? new Date(data.timestamp / 1000000).toLocaleTimeString() : '-';
                const optionType = symbol.includes('C') ? 'Call' : 'Put';
                return `
                    <tr>
                        <td class="symbol">${symbol}</td>
                        <td class="price-up">${data.bid_price || '-'}</td>
                        <td class="price-down">${data.ask_price || '-'}</td>
                        <td>${optionType}</td>
                        <td>${time}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rows.length > 0 ? rows.join('') : 
                '<tr><td colspan="5" style="text-align: center; opacity: 0.6;">æš‚æ— æµ‹è¯•æœŸæƒæ•°æ®</td></tr>';
        }
        
        function updateSubscriptionCounts(symbols) {
            const stocks = symbols.filter(s => s.length <= 10);
            const options = symbols.filter(s => s.length > 10);
            
            document.getElementById('stock-count').textContent = stocks.length;
            document.getElementById('option-count').textContent = options.length;
        }
        
        function updateConnectionStatus(type, status) {
            let elementId;
            switch (type) {
                case 'production':
                    elementId = 'production-status';
                    break;
                case 'test':
                    elementId = 'test-status';
                    break;
                case 'option':
                    elementId = 'option-status';
                    break;
                default:
                    elementId = type === 'production' ? 'production-status' : 'test-status';
            }
            
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.className = `status-value status-${status}`;
            
            switch (status) {
                case 'online':
                    element.textContent = 'å·²è¿æ¥';
                    break;
                case 'offline':
                    element.textContent = 'æœªè¿æ¥';
                    break;
                case 'connecting':
                    element.textContent = 'è¿æ¥ä¸­...';
                    break;
            }
        }
        
        function sendPing() {
            let sent = false;
            
            if (productionWebSocket && productionWebSocket.readyState === WebSocket.OPEN) {
                const message = { type: 'ping', timestamp: new Date().toISOString() };
                productionWebSocket.send(JSON.stringify(message));
                log('info', '[ç”Ÿäº§] å‘é€å¿ƒè·³åŒ…');
                sent = true;
            }
            
            if (testWebSocket && testWebSocket.readyState === WebSocket.OPEN) {
                const message = { action: 'ping', timestamp: new Date().toISOString() };
                testWebSocket.send(JSON.stringify(message));
                log('info', '[æµ‹è¯•] å‘é€å¿ƒè·³åŒ…');
                sent = true;
            }
            
            if (!sent) {
                log('warning', 'æ²¡æœ‰å¯ç”¨çš„WebSocketè¿æ¥ï¼Œæ— æ³•å‘é€å¿ƒè·³');
            }
        }
        
        async function getJWTToken() {
            try {
                log('info', 'æ­£åœ¨è·å–æ¼”ç¤ºJWT Token...');
                const response = await fetch('http://localhost:8091/api/v1/auth/demo-token');
                const data = await response.json();
                
                if (response.ok) {
                    jwtToken = data.access_token;
                    log('success', `JWT Tokenè·å–æˆåŠŸ: ${jwtToken.substring(0, 50)}...`);
                    log('info', `Tokenæœ‰æ•ˆæœŸ: ${data.expires_in / 3600} å°æ—¶`);
                    log('info', `æ¼”ç¤ºç”¨æˆ·: ${data.demo_user.username} (${data.demo_user.email})`);
                    
                    // å¤åˆ¶åˆ°å‰ªè´´æ¿
                    if (navigator.clipboard) {
                        await navigator.clipboard.writeText(jwtToken);
                        log('success', 'JWT Tokenå·²å¤åˆ¶åˆ°å‰ªè´´æ¿!');
                    }
                } else {
                    log('error', `è·å–JWT Tokenå¤±è´¥: ${data.detail}`);
                }
            } catch (error) {
                log('error', `è·å–JWT Tokené”™è¯¯: ${error.message}`);
            }
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            productionMessageCount = 0;
            testMessageCount = 0;
            optionMessageCount = 0;
            document.getElementById('production-message-count').textContent = '0';
            document.getElementById('test-message-count').textContent = '0';
            document.getElementById('option-message-count').textContent = '0';
        }
        
        function log(type, message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span>${message}`;
            
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ¡æ•°
            const entries = logs.querySelectorAll('.log-entry');
            if (entries.length > 100) {
                entries[0].remove();
            }
        }
        
        // Test MsgPack functionality manually
        function testMsgPackFunctionality() {
            if (!msgpackAvailable) {
                log('error', 'æ— æ³•æµ‹è¯•MsgPack - åº“æœªåŠ è½½');
                return;
            }
            
            try {
                const testData = { 
                    action: 'test', 
                    symbol: 'AAPL250808C00210000', 
                    timestamp: Date.now() 
                };
                
                // Test encoding
                const encoded = MessagePack.encode(testData);
                log('success', `MsgPackç¼–ç æµ‹è¯•æˆåŠŸ: ${encoded.byteLength} bytes`);
                
                // Test decoding
                const decoded = MessagePack.decode(encoded);
                log('success', `MsgPackè§£ç æµ‹è¯•æˆåŠŸ: ${JSON.stringify(decoded)}`);
                
                if (JSON.stringify(testData) === JSON.stringify(decoded)) {
                    log('success', 'MsgPackå®Œæ•´æ€§æµ‹è¯•é€šè¿‡ - å¯ç”¨äºæœŸæƒWebSocket');
                } else {
                    log('error', 'MsgPackå®Œæ•´æ€§æµ‹è¯•å¤±è´¥ - æ•°æ®ä¸ä¸€è‡´');
                }
            } catch (error) {
                log('error', `MsgPackåŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºåˆå§‹ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', function() {
            log('info', 'ğŸš€ Opitios Alpaca WebSocket åŒç«¯ç‚¹æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('info', 'âœ… æ”¯æŒåŒæ—¶è¿æ¥ç”Ÿäº§ç«¯ç‚¹å’Œæµ‹è¯•ç«¯ç‚¹');
            log('info', 'ğŸ“Š ç”Ÿäº§ç«¯ç‚¹: æœ¬åœ°æœåŠ¡å™¨ (localhost:8091)');
            log('info', 'ğŸ§ª æµ‹è¯•ç«¯ç‚¹: Alpaca å®˜æ–¹æµ‹è¯•ç«¯ç‚¹ (stream.data.alpaca.markets)');
            log('info', 'ğŸ“Š æœŸæƒç«¯ç‚¹: Alpaca æœŸæƒæ•°æ®æµ (v1beta1/indicative) - æ”¯æŒMsgPack');
            log('info', 'ğŸ”§ å¯å•ç‹¬è¿æ¥ä»»ä¸€ç«¯ç‚¹æˆ–åŒæ—¶è¿æ¥å¤šä¸ªç«¯ç‚¹');
            log('info', 'ğŸ“ˆ å®æ—¶å¯¹æ¯”å¤šä¸ªæ•°æ®æºçš„è‚¡ç¥¨å’ŒæœŸæƒæ•°æ®');
            log('info', 'ğŸ”‘ ç‚¹å‡»"è·å–æ¼”ç¤ºJWT"è·å–APIæµ‹è¯•token');
            
            // Check MsgPack library availability after page load with multiple attempts
            let attempts = 0;
            const maxAttempts = 10;
            
            function tryCheckMsgPack() {
                attempts++;
                if (checkMsgPackAvailability()) {
                    // Library loaded successfully, test functionality
                    setTimeout(testMsgPackFunctionality, 500);
                } else if (attempts < maxAttempts) {
                    // Retry after delay
                    setTimeout(tryCheckMsgPack, 200);
                } else {
                    log('error', `MsgPackåº“åŠ è½½å¤±è´¥ï¼Œå·²å°è¯• ${maxAttempts} æ¬¡`);
                    log('warning', 'æœŸæƒWebSocketå°†æ— æ³•å·¥ä½œï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            }
            
            // Initial check after a short delay to allow CDN loading
            setTimeout(tryCheckMsgPack, 300);
        });
    </script>
</body>
</html>