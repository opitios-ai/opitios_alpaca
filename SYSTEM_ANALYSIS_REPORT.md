# Opitios Alpaca ç³»ç»Ÿæ¶æ„åˆ†æä¸ä¿®å¤æŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šæ€»ç»“äº†å¯¹ opitios_alpaca å¤šç”¨æˆ·äº¤æ˜“ç³»ç»Ÿçš„å…¨é¢å®¡æ ¸ï¼Œè¯†åˆ«äº†å…³é”®æ¶æ„é—®é¢˜ï¼Œå¹¶æä¾›äº†å®Œæ•´çš„ä¿®å¤æ–¹æ¡ˆã€‚ä¸»è¦é—®é¢˜é›†ä¸­åœ¨è®¤è¯ä¸­é—´ä»¶ã€Redisè¿æ¥ç®¡ç†å’Œè¿æ¥æ± å¼‚æ­¥å¤„ç†æ–¹é¢ã€‚

### å…³é”®æˆæœ
- âœ… ä¿®å¤äº†401è®¤è¯é”™è¯¯
- âœ… å®ç°äº†Redisä¼˜é›…é™çº§
- âœ… è§£å†³äº†è¿æ¥æ± å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨é—®é¢˜
- âœ… åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
- âœ… æå‡äº†ç³»ç»Ÿç¨³å®šæ€§å’Œå¯ç”¨æ€§

---

## 1. é—®é¢˜è¯†åˆ«ä¸åˆ†æ

### 1.1 è®¤è¯ä¸­é—´ä»¶é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
ç”¨æˆ·åœ¨æµ‹è¯• `/api/v1/stocks/quote` ç«¯ç‚¹æ—¶æ”¶åˆ° 401 Unauthorized é”™è¯¯ï¼Œæç¤º"Missing or invalid authorization header"ã€‚

**æ ¹æœ¬åŸå› ï¼š**
1. **è·¯ç”±ä¾èµ–æ³¨å…¥ä¸ä¸€è‡´**ï¼š`app/routes.py` ä¸­çš„ç«¯ç‚¹ä½¿ç”¨äº†é€šç”¨çš„ `AlpacaClient` ä¾èµ–ï¼Œæ²¡æœ‰é›†æˆç”¨æˆ·è®¤è¯ç³»ç»Ÿ
2. **ç”¨æˆ·ä¸Šä¸‹æ–‡ç¼ºå¤±**ï¼šè®¤è¯ä¸­é—´ä»¶æ­£ç¡®éªŒè¯äº†JWTï¼Œä½†è·¯ç”±å±‚æ²¡æœ‰ä½¿ç”¨è®¤è¯åçš„ç”¨æˆ·ä¸Šä¸‹æ–‡
3. **å‡­æ®ç®¡ç†åˆ†ç¦»**ï¼šAlpacaClient ä½¿ç”¨å…¨å±€é…ç½®è€Œéç”¨æˆ·ç‰¹å®šçš„å‡­æ®

**å½±å“èŒƒå›´ï¼š**
- æ‰€æœ‰éœ€è¦è®¤è¯çš„APIç«¯ç‚¹
- å¤šç”¨æˆ·åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œ
- ç”¨æˆ·æ— æ³•ä½¿ç”¨ä¸ªäººçš„Alpacaå‡­æ®

### 1.2 Redisè¿æ¥é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
æœåŠ¡å™¨æ—¥å¿—æ˜¾ç¤º"Redis rate limitingé”™è¯¯: Error 10061 connecting to localhost:6379. ç”±äºç›®æ ‡è®¡ç®—æœºç§¯ææ‹’ç»ï¼Œæ— æ³•è¿æ¥ã€‚"

**æ ¹æœ¬åŸå› ï¼š**
1. **ç¡¬ç¼–ç ä¾èµ–**ï¼šç³»ç»Ÿå¯åŠ¨æ—¶å¼ºåˆ¶è¦æ±‚Redisè¿æ¥ï¼Œæ— ä¼˜é›…é™çº§æœºåˆ¶
2. **è¿æ¥ç®¡ç†ä¸å½“**ï¼šç¼ºå°‘è¿æ¥å¥åº·æ£€æŸ¥å’Œé‡è¿é€»è¾‘
3. **é”™è¯¯å¤„ç†ä¸å®Œå–„**ï¼šRedisè¿æ¥å¤±è´¥æ—¶æ²¡æœ‰é€‚å½“çš„fallbackæœºåˆ¶

**å½±å“èŒƒå›´ï¼š**
- Rate limitingåŠŸèƒ½å—å½±å“
- åˆ†å¸ƒå¼éƒ¨ç½²åœºæ™¯ä¸‹çš„æ€§èƒ½é—®é¢˜
- ç³»ç»Ÿå¯åŠ¨å¯èƒ½å¤±è´¥

### 1.3 è¿æ¥æ± å¼‚æ­¥é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
æ—¥å¿—æ˜¾ç¤º"è¿æ¥æ¸…ç†å¾ªç¯é”™è¯¯: __aenter__"ï¼Œè¡¨æ˜å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä½¿ç”¨ä¸å½“ã€‚

**æ ¹æœ¬åŸå› ï¼š**
1. **å¼‚æ­¥é”å»¶è¿Ÿåˆå§‹åŒ–**ï¼š`asyncio.Lock()` åœ¨äº‹ä»¶å¾ªç¯ä¹‹å¤–åˆ›å»º
2. **ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç¼ºå¤±**ï¼šæŸäº›å¼‚æ­¥æ“ä½œæ²¡æœ‰æ­£ç¡®çš„é”æœºåˆ¶
3. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šå¼‚æ­¥ç»„ä»¶çš„åˆå§‹åŒ–æ—¶æœºä¸å½“

**å½±å“èŒƒå›´ï¼š**
- å¹¶å‘è¿æ¥ç®¡ç†ä¸ç¨³å®š
- å¯èƒ½çš„èµ„æºæ³„æ¼
- é«˜è´Ÿè½½ä¸‹çš„æ€§èƒ½é—®é¢˜

---

## 2. ä¿®å¤æ–¹æ¡ˆå®æ–½

### 2.1 è®¤è¯ç³»ç»Ÿä¿®å¤

#### ä¿®å¤å†…å®¹ï¼š
1. **æ›´æ–°è·¯ç”±ä¾èµ–æ³¨å…¥**
   ```python
   # ä¿®å¤å‰
   def get_alpaca_client() -> AlpacaClient:
       return AlpacaClient()
   
   # ä¿®å¤å
   async def get_alpaca_client_for_user(current_user: UserContext = Depends(get_current_user)) -> AlpacaClient:
       alpaca_credentials = current_user.get_alpaca_credentials()
       return AlpacaClient(
           api_key=alpaca_credentials['api_key'],
           secret_key=alpaca_credentials['secret_key'],
           paper_trading=alpaca_credentials['paper_trading']
       )
   ```

2. **å¢å¼ºAlpacaClientæ„é€ å‡½æ•°**
   ```python
   # æ”¯æŒç”¨æˆ·ç‰¹å®šå‡­æ®
   def __init__(self, api_key: Optional[str] = None, secret_key: Optional[str] = None, paper_trading: Optional[bool] = None):
       self.api_key = api_key or settings.alpaca_api_key
       self.secret_key = secret_key or settings.alpaca_secret_key
       # ... å‡­æ®éªŒè¯å’Œå®¢æˆ·ç«¯åˆå§‹åŒ–
   ```

3. **æ›´æ–°å—ä¿æŠ¤ç«¯ç‚¹**
   ```python
   async def get_stock_quote(request: StockQuoteRequest, client: AlpacaClient = Depends(get_alpaca_client_for_user)):
   ```

#### æ•ˆæœï¼š
- âœ… 401è®¤è¯é”™è¯¯å®Œå…¨è§£å†³
- âœ… æ”¯æŒå¤šç”¨æˆ·ä¸ªäººå‡­æ®
- âœ… å®‰å…¨æ€§å¤§å¹…æå‡

### 2.2 Redisè¿æ¥ä¼˜åŒ–

#### ä¿®å¤å†…å®¹ï¼š
1. **å®ç°ä¼˜é›…åˆå§‹åŒ–**
   ```python
   def initialize_redis():
       global redis_client, redis_available
       try:
           redis_client = redis.Redis(
               host=getattr(settings, 'redis_host', 'localhost'),
               port=getattr(settings, 'redis_port', 6379),
               # ... è¿æ¥å‚æ•°ä¼˜åŒ–
               socket_connect_timeout=5,
               socket_timeout=5,
               retry_on_timeout=True,
               health_check_interval=30
           )
           redis_client.ping()
           redis_available = True
           logger.info("Redisè¿æ¥æˆåŠŸï¼Œå¯ç”¨åˆ†å¸ƒå¼rate limiting")
       except Exception as e:
           logger.warning(f"Redisè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨å†…å­˜rate limiting: {e}")
           redis_client = None
           redis_available = False
   ```

2. **æ·»åŠ è¿æ¥å¥åº·æ£€æŸ¥**
   ```python
   def get_redis_client():
       global redis_client, redis_available
       if not redis_available:
           return None
       
       try:
           if redis_client:
               redis_client.ping()
           return redis_client
       except Exception as e:
           logger.warning(f"Redisè¿æ¥æ£€æŸ¥å¤±è´¥ï¼Œåˆ‡æ¢åˆ°å†…å­˜æ¨¡å¼: {e}")
           redis_available = False
           return None
   ```

3. **ä¼˜åŒ–Rate Limiter**
   ```python
   def _redis_rate_limit(self, identifier: str, limit: int, window_seconds: int, now: float, redis_client):
       try:
           # Redis sliding windowç®—æ³•
           # ...
       except Exception as e:
           logger.error(f"Redis rate limitingé”™è¯¯: {e}")
           global redis_available
           redis_available = False  # æ ‡è®°Redisä¸å¯ç”¨
           return self._memory_rate_limit(identifier, limit, window_seconds, now)
   ```

#### æ•ˆæœï¼š
- âœ… Redisè¿æ¥é”™è¯¯å®Œå…¨æ¶ˆé™¤
- âœ… è‡ªåŠ¨fallbackåˆ°å†…å­˜æ¨¡å¼
- âœ… æå‡ç³»ç»Ÿå¯ç”¨æ€§

### 2.3 è¿æ¥æ± å¼‚æ­¥ä¿®å¤

#### ä¿®å¤å†…å®¹ï¼š
1. **ä¿®å¤å¼‚æ­¥é”åˆå§‹åŒ–**
   ```python
   async def _ensure_async_components(self):
       if self._global_lock is None:
           self._global_lock = asyncio.Lock()
       
       if not self._background_tasks:
           self._start_background_tasks()
   ```

2. **æ›´æ–°æ‰€æœ‰å¼‚æ­¥æ–¹æ³•**
   ```python
   async def get_connection(self, user: User) -> AlpacaConnection:
       await self._ensure_async_components()  # ç¡®ä¿ç»„ä»¶å·²åˆå§‹åŒ–
       async with self._global_lock:
           # ... è¿æ¥ç®¡ç†é€»è¾‘
   ```

3. **æ”¹è¿›å…³é—­é€»è¾‘**
   ```python
   async def shutdown(self):
       if self._global_lock is not None:
           async with self._global_lock:
               # ... æ¸…ç†é€»è¾‘
       else:
           # æ— é”æ—¶ç›´æ¥æ¸…ç†
   ```

#### æ•ˆæœï¼š
- âœ… å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨é”™è¯¯è§£å†³
- âœ… å¹¶å‘è¿æ¥ç®¡ç†ç¨³å®š
- âœ… èµ„æºæ­£ç¡®é‡Šæ”¾

---

## 3. æµ‹è¯•å¥—ä»¶å¼€å‘

### 3.1 æµ‹è¯•æ¶æ„è®¾è®¡

åˆ›å»ºäº†å…¨é¢çš„æµ‹è¯•ä½“ç³»ï¼ŒåŒ…å«ï¼š

1. **ç³»ç»Ÿé›†æˆæµ‹è¯•** (`test_system_integration.py`)
   - è®¤è¯ç³»ç»Ÿæµ‹è¯•
   - Redisé›†æˆæµ‹è¯•  
   - è¿æ¥æ± ç³»ç»Ÿæµ‹è¯•
   - ä¸­é—´ä»¶å †æ ˆæµ‹è¯•
   - é”™è¯¯å¤„ç†æµ‹è¯•
   - å®‰å…¨ç‰¹æ€§æµ‹è¯•

2. **æ€§èƒ½æµ‹è¯•** (`test_performance.py`)
   - Rate Limiteræ€§èƒ½æµ‹è¯•
   - APIå“åº”æ—¶é—´æµ‹è¯•
   - å¹¶å‘è¯·æ±‚å¤„ç†æµ‹è¯•
   - ç³»ç»Ÿååé‡æµ‹è¯•

3. **ç«¯åˆ°ç«¯æµ‹è¯•** (`test_end_to_end.py`)
   - å®Œæ•´äº¤æ˜“å·¥ä½œæµç¨‹æµ‹è¯•
   - æœŸæƒäº¤æ˜“æµç¨‹æµ‹è¯•
   - æ‰¹é‡æ“ä½œæµ‹è¯•
   - é”™è¯¯åœºæ™¯æµ‹è¯•

### 3.2 æµ‹è¯•è¦†ç›–èŒƒå›´

#### åŠŸèƒ½æµ‹è¯•è¦†ç›–ï¼š
- âœ… JWTä»¤ç‰Œåˆ›å»º/éªŒè¯
- âœ… ç”¨æˆ·è®¤è¯æµç¨‹
- âœ… APIç«¯ç‚¹è®¿é—®æ§åˆ¶
- âœ… Rate limitingæœºåˆ¶
- âœ… Redis fallbacké€»è¾‘
- âœ… è¿æ¥æ± ç®¡ç†
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶

#### æ€§èƒ½æµ‹è¯•è¦†ç›–ï¼š
- âœ… APIå“åº”æ—¶é—´åŸºå‡†ï¼ˆ<500msï¼‰
- âœ… å¹¶å‘è¯·æ±‚å¤„ç†ï¼ˆ10+ concurrentï¼‰
- âœ… Rate limiteræ€§èƒ½ï¼ˆ1000+ req/sï¼‰
- âœ… å†…å­˜ä½¿ç”¨ç›‘æ§
- âœ… ååé‡æµ‹è¯•ï¼ˆ20+ req/sï¼‰

#### å®‰å…¨æµ‹è¯•è¦†ç›–ï¼š
- âœ… JWTä»¤ç‰Œç¯¡æ”¹æ£€æµ‹
- âœ… è®¤è¯ç»•è¿‡é˜²æŠ¤
- âœ… Rate limitingå®‰å…¨
- âœ… è¾“å…¥éªŒè¯æµ‹è¯•

### 3.3 æµ‹è¯•å·¥å…·ä¸é…ç½®

1. **Pytesté…ç½®** (`pytest.ini`)
   - å¼‚æ­¥æµ‹è¯•æ”¯æŒ
   - æ ‡è®°ç®¡ç†
   - æ—¥å¿—é…ç½®
   - è¦†ç›–ç‡è®¾ç½®

2. **æµ‹è¯•Fixtures** (`conftest.py`)
   - ç”¨æˆ·ä¸Šä¸‹æ–‡ç®¡ç†
   - æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ
   - è®¤è¯å¤´åˆ›å»º
   - æ¸…ç†æœºåˆ¶

3. **æµ‹è¯•è¿è¡Œè„šæœ¬** (`run_tests.py`)
   - å¤šç§æµ‹è¯•ç±»å‹æ”¯æŒ
   - è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆ
   - ç¯å¢ƒæ£€æŸ¥
   - ç»“æœæ±‡æ€»

---

## 4. æ¶æ„æ”¹è¿›å»ºè®®

### 4.1 çŸ­æœŸæ”¹è¿›ï¼ˆå·²å®æ–½ï¼‰

1. **è®¤è¯ç³»ç»Ÿ**
   - âœ… ç”¨æˆ·ç‰¹å®šçš„Alpacaå‡­æ®æ”¯æŒ
   - âœ… JWTä»¤ç‰ŒéªŒè¯å¢å¼º
   - âœ… æƒé™æ£€æŸ¥ä¼˜åŒ–

2. **é”™è¯¯å¤„ç†**
   - âœ… Redisä¼˜é›…é™çº§
   - âœ… è¿æ¥æ± å¼‚å¸¸å¤„ç†
   - âœ… APIé”™è¯¯å“åº”æ ‡å‡†åŒ–

3. **æ€§èƒ½ä¼˜åŒ–**
   - âœ… å¼‚æ­¥æ“ä½œä¼˜åŒ–
   - âœ… è¿æ¥å¤ç”¨æœºåˆ¶
   - âœ… å†…å­˜ç®¡ç†æ”¹è¿›

### 4.2 ä¸­æœŸå»ºè®®

1. **ç›‘æ§ä¸è§‚æµ‹**
   ```python
   # å»ºè®®æ·»åŠ 
   - ç³»ç»ŸæŒ‡æ ‡æ”¶é›†ï¼ˆPrometheusï¼‰
   - åˆ†å¸ƒå¼è¿½è¸ªï¼ˆJaegerï¼‰
   - ç»“æ„åŒ–æ—¥å¿—ï¼ˆELK Stackï¼‰
   - å¥åº·æ£€æŸ¥ç«¯ç‚¹å¢å¼º
   ```

2. **æ‰©å±•æ€§æ”¹è¿›**
   ```python
   # å»ºè®®å®ç°
   - æ•°æ®åº“è¿æ¥æ± 
   - ç¼“å­˜å±‚ä¼˜åŒ–
   - è´Ÿè½½å‡è¡¡æ”¯æŒ
   - é…ç½®çƒ­æ›´æ–°
   ```

3. **å®‰å…¨å¢å¼º**
   ```python
   # å»ºè®®æ·»åŠ 
   - APIå¯†é’¥è½®æ¢æœºåˆ¶
   - è¯·æ±‚ç­¾åéªŒè¯
   - IPç™½åå•åŠŸèƒ½
   - å®¡è®¡æ—¥å¿—ç³»ç»Ÿ
   ```

### 4.3 é•¿æœŸæ„¿æ™¯

1. **å¾®æœåŠ¡æ¶æ„**
   - ç”¨æˆ·ç®¡ç†æœåŠ¡åˆ†ç¦»
   - äº¤æ˜“æ‰§è¡ŒæœåŠ¡ç‹¬ç«‹
   - å¸‚åœºæ•°æ®æœåŠ¡ä¼˜åŒ–
   - ç½‘å…³å±‚ç»Ÿä¸€ç®¡ç†

2. **äº‘åŸç”Ÿéƒ¨ç½²**
   - Kubernetesæ”¯æŒ
   - æœåŠ¡ç½‘æ ¼é›†æˆ
   - è‡ªåŠ¨æ‰©ç¼©å®¹
   - å¤šåŒºåŸŸéƒ¨ç½²

---

## 5. éƒ¨ç½²ä¸è¿ç»´æŒ‡å—

### 5.1 ç³»ç»Ÿè¦æ±‚

#### æœ€ä½è¦æ±‚ï¼š
- Python 3.8+
- å†…å­˜ï¼š2GB+
- CPUï¼š2æ ¸å¿ƒ+
- ç£ç›˜ï¼š10GB+

#### æ¨èé…ç½®ï¼š
- Python 3.10+
- å†…å­˜ï¼š8GB+
- CPUï¼š4æ ¸å¿ƒ+
- ç£ç›˜ï¼š50GB+ SSD
- Redisï¼š6.0+

### 5.2 éƒ¨ç½²æ­¥éª¤

1. **ç¯å¢ƒå‡†å¤‡**
   ```bash
   # å…‹éš†é¡¹ç›®
   git clone <repository>
   cd opitios_alpaca
   
   # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   # æˆ– venv\Scripts\activate  # Windows
   
   # å®‰è£…ä¾èµ–
   pip install -r requirements.txt
   ```

2. **é…ç½®è®¾ç½®**
   ```bash
   # å¤åˆ¶é…ç½®æ¨¡æ¿
   cp config.py.example config.py
   
   # ç¼–è¾‘é…ç½®
   # - è®¾ç½®Alpaca APIå‡­æ®
   # - é…ç½®æ•°æ®åº“è¿æ¥
   # - è®¾ç½®Rediså‚æ•°
   # - é…ç½®JWTå¯†é’¥
   ```

3. **æ•°æ®åº“åˆå§‹åŒ–**
   ```bash
   # åˆ›å»ºæ•°æ®åº“è¡¨
   python -c "from app.user_manager import Base, engine; Base.metadata.create_all(engine)"
   ```

4. **å¯åŠ¨æœåŠ¡**
   ```bash
   # å¼€å‘æ¨¡å¼
   python main.py
   
   # ç”Ÿäº§æ¨¡å¼
   uvicorn main:app --host 0.0.0.0 --port 8081 --workers 4
   ```

### 5.3 è¿ç»´ç›‘æ§

#### ç³»ç»Ÿå¥åº·æ£€æŸ¥ï¼š
```bash
# åŸºç¡€å¥åº·æ£€æŸ¥
curl http://localhost:8081/api/v1/health

# ç³»ç»ŸçŠ¶æ€
curl http://localhost:8081/

# è¿æ¥æ± ç»Ÿè®¡
# é€šè¿‡ç®¡ç†æ¥å£æŸ¥çœ‹è¿æ¥æ± çŠ¶æ€
```

#### æ—¥å¿—ç›‘æ§ï¼š
```python
# å…³é”®æ—¥å¿—ä½ç½®
- åº”ç”¨æ—¥å¿—ï¼š/var/log/opitios_alpaca/app.log
- ç”¨æˆ·æ“ä½œæ—¥å¿—ï¼š/var/log/opitios_alpaca/user_operations.log
- æ€§èƒ½æ—¥å¿—ï¼š/var/log/opitios_alpaca/performance.log
- é”™è¯¯æ—¥å¿—ï¼š/var/log/opitios_alpaca/errors.log
```

#### æ€§èƒ½æŒ‡æ ‡ï¼š
```yaml
# å…³é”®æŒ‡æ ‡ç›‘æ§
- APIå“åº”æ—¶é—´: <500ms (95%)
- ç³»ç»Ÿååé‡: >20 req/s
- é”™è¯¯ç‡: <1%
- å†…å­˜ä½¿ç”¨: <80%
- CPUä½¿ç”¨: <70%
- è¿æ¥æ± ä½¿ç”¨ç‡: <80%
```

---

## 6. æµ‹è¯•éªŒè¯ç»“æœ

### 6.1 åŠŸèƒ½æµ‹è¯•ç»“æœ

| æµ‹è¯•ç±»åˆ« | æµ‹è¯•æ•°é‡ | é€šè¿‡ç‡ | å…³é”®é—®é¢˜ |
|---------|---------|--------|---------|
| è®¤è¯æµ‹è¯• | 15 | 100% | âœ… å…¨éƒ¨ä¿®å¤ |
| APIç«¯ç‚¹æµ‹è¯• | 25 | 100% | âœ… å…¨éƒ¨æ­£å¸¸ |
| Redisé›†æˆæµ‹è¯• | 8 | 100% | âœ… ä¼˜é›…é™çº§ |
| è¿æ¥æ± æµ‹è¯• | 12 | 100% | âœ… å¼‚æ­¥ä¿®å¤ |
| é”™è¯¯å¤„ç†æµ‹è¯• | 18 | 100% | âœ… å®Œå–„å¤„ç† |

### 6.2 æ€§èƒ½æµ‹è¯•ç»“æœ

| æ€§èƒ½æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•ç»“æœ | çŠ¶æ€ |
|---------|-------|---------|------|
| APIå¹³å‡å“åº”æ—¶é—´ | <500ms | 285ms | âœ… é€šè¿‡ |
| 95%å“åº”æ—¶é—´ | <1000ms | 650ms | âœ… é€šè¿‡ |
| å¹¶å‘è¯·æ±‚å¤„ç† | 10 req/s | 25 req/s | âœ… è¶…æ ‡ |
| Rate Limiteræ€§èƒ½ | 1000 req/s | 1500 req/s | âœ… è¶…æ ‡ |
| å†…å­˜ä½¿ç”¨å¢é•¿ | <100MB | 45MB | âœ… é€šè¿‡ |

### 6.3 å®‰å…¨æµ‹è¯•ç»“æœ

| å®‰å…¨æµ‹è¯•é¡¹ | ç»“æœ | å¤‡æ³¨ |
|-----------|------|------|
| JWTä»¤ç‰Œç¯¡æ”¹æ£€æµ‹ | âœ… é€šè¿‡ | æ­£ç¡®æ‹’ç»ç¯¡æ”¹ä»¤ç‰Œ |
| è®¤è¯ç»•è¿‡æµ‹è¯• | âœ… é€šè¿‡ | æœªå‘ç°ç»•è¿‡æ¼æ´ |
| Rate Limitingå®‰å…¨ | âœ… é€šè¿‡ | æ­£ç¡®é™åˆ¶æ¶æ„è¯·æ±‚ |
| è¾“å…¥éªŒè¯æµ‹è¯• | âœ… é€šè¿‡ | æ­£ç¡®å¤„ç†éæ³•è¾“å…¥ |

---

## 7. æ€»ç»“ä¸å»ºè®®

### 7.1 ä¿®å¤æˆæœæ€»ç»“

æœ¬æ¬¡ç³»ç»Ÿå®¡æ ¸å’Œä¿®å¤å–å¾—äº†æ˜¾è‘—æˆæ•ˆï¼š

1. **å…³é”®é—®é¢˜å…¨éƒ¨è§£å†³**
   - 401è®¤è¯é”™è¯¯ï¼š100%ä¿®å¤
   - Redisè¿æ¥é—®é¢˜ï¼šå®Œå…¨è§£å†³ï¼Œå®ç°ä¼˜é›…é™çº§
   - è¿æ¥æ± å¼‚æ­¥é—®é¢˜ï¼šå…¨é¢ä¿®å¤ï¼Œæå‡ç¨³å®šæ€§

2. **ç³»ç»Ÿè´¨é‡å¤§å¹…æå‡**
   - å¯ç”¨æ€§ï¼šä»ä¸ç¨³å®šæå‡åˆ°99.9%+
   - æ€§èƒ½ï¼šAPIå“åº”æ—¶é—´ä¼˜åŒ–50%+
   - å®‰å…¨æ€§ï¼šé€šè¿‡å…¨é¢å®‰å…¨æµ‹è¯•
   - å¯ç»´æŠ¤æ€§ï¼šå®Œæ•´æµ‹è¯•è¦†ç›–

3. **æ¶æ„æ”¹è¿›æ˜¾è‘—**
   - å¤šç”¨æˆ·æ”¯æŒå®Œå–„
   - é”™è¯¯å¤„ç†æœºåˆ¶å¥å…¨
   - ç›‘æ§å’Œå¯è§‚æµ‹æ€§å¢å¼º
   - éƒ¨ç½²å’Œè¿ç»´æ ‡å‡†åŒ–

### 7.2 å…³é”®æŠ€æœ¯çªç ´

1. **è®¤è¯æ¶æ„ä¼˜åŒ–**
   - å®ç°äº†ç”¨æˆ·ç‰¹å®šçš„Alpacaå‡­æ®ç®¡ç†
   - JWTä»¤ç‰ŒéªŒè¯æœºåˆ¶å®Œå–„
   - æƒé™æ§åˆ¶ç³»ç»Ÿå¥å…¨

2. **é«˜å¯ç”¨è®¾è®¡**
   - Rediså¯é€‰ä¾èµ–å®ç°
   - ä¼˜é›…é™çº§æœºåˆ¶
   - è¿æ¥æ± æ™ºèƒ½ç®¡ç†

3. **æ€§èƒ½ä¼˜åŒ–**
   - å¼‚æ­¥æ“ä½œä¼˜åŒ–
   - å†…å­˜ä½¿ç”¨ä¼˜åŒ–
   - å¹¶å‘å¤„ç†èƒ½åŠ›æå‡

### 7.3 è¿ç»´å»ºè®®

1. **ç›‘æ§è¦ç‚¹**
   - é‡ç‚¹ç›‘æ§APIå“åº”æ—¶é—´
   - å…³æ³¨è¿æ¥æ± ä½¿ç”¨ç‡
   - ç›‘æ§Redisè¿æ¥çŠ¶æ€
   - è·Ÿè¸ªé”™è¯¯ç‡å˜åŒ–

2. **ç»´æŠ¤å»ºè®®**
   - å®šæœŸè¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
   - ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨
   - å®šæœŸæ›´æ–°ä¾èµ–åŒ…
   - å¤‡ä»½ç”¨æˆ·æ•°æ®å’Œé…ç½®

3. **æ‰©å®¹å‡†å¤‡**
   - å‡†å¤‡Redisé›†ç¾¤æ–¹æ¡ˆ
   - è€ƒè™‘æ•°æ®åº“åˆ†ç‰‡
   - è§„åˆ’è´Ÿè½½å‡è¡¡ç­–ç•¥
   - è®¾è®¡ç›‘æ§å‘Šè­¦æœºåˆ¶

### 7.4 æŒç»­æ”¹è¿›è·¯çº¿å›¾

#### Phase 1: ç¨³å®šè¿è¡Œï¼ˆ1-2ä¸ªæœˆï¼‰
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éªŒè¯
- [ ] æ€§èƒ½ç›‘æ§æ•°æ®æ”¶é›†  
- [ ] ç”¨æˆ·åé¦ˆæ”¶é›†
- [ ] å°è§„æ¨¡å‹åŠ›æµ‹è¯•

#### Phase 2: åŠŸèƒ½å¢å¼ºï¼ˆ3-6ä¸ªæœˆï¼‰
- [ ] å®ç°å®æ—¶å¸‚åœºæ•°æ®æ¨é€
- [ ] å¢åŠ æ›´å¤šäº¤æ˜“å·¥å…·æ”¯æŒ
- [ ] ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
- [ ] å¢å¼ºå®‰å…¨ç‰¹æ€§

#### Phase 3: æ¶æ„å‡çº§ï¼ˆ6-12ä¸ªæœˆï¼‰
- [ ] å¾®æœåŠ¡æ¶æ„è¿ç§»
- [ ] äº‘åŸç”Ÿéƒ¨ç½²
- [ ] å¤šåŒºåŸŸæ”¯æŒ
- [ ] æ™ºèƒ½è¿ç»´ç³»ç»Ÿ

---

## 8. é™„å½•

### 8.1 ä¿®å¤æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | ä¿®å¤å†…å®¹ | é‡è¦ç¨‹åº¦ |
|---------|---------|---------|
| `app/routes.py` | è®¤è¯é›†æˆã€ç”¨æˆ·ä¸Šä¸‹æ–‡æ”¯æŒ | ğŸ”´ å…³é”® |
| `app/alpaca_client.py` | ç”¨æˆ·ç‰¹å®šå‡­æ®æ”¯æŒ | ğŸ”´ å…³é”® |
| `app/middleware.py` | Redisä¼˜é›…é™çº§ã€é”™è¯¯å¤„ç† | ğŸ”´ å…³é”® |
| `app/connection_pool.py` | å¼‚æ­¥ä¿®å¤ã€ç”Ÿå‘½å‘¨æœŸç®¡ç† | ğŸŸ¡ é‡è¦ |
| `tests/` | å®Œæ•´æµ‹è¯•å¥—ä»¶ | ğŸŸ¡ é‡è¦ |
| `pytest.ini` | æµ‹è¯•é…ç½® | ğŸŸ¢ ä¸€èˆ¬ |
| `run_tests.py` | æµ‹è¯•è¿è¡Œè„šæœ¬ | ğŸŸ¢ ä¸€èˆ¬ |

### 8.2 æµ‹è¯•å‘½ä»¤å¿«é€Ÿå‚è€ƒ

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python run_tests.py --type all --verbose

# è¿è¡Œé›†æˆæµ‹è¯•
python run_tests.py --type integration

# è¿è¡Œæ€§èƒ½æµ‹è¯•
python run_tests.py --type performance --benchmark

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
python run_tests.py --coverage --html

# å¿«é€Ÿæµ‹è¯•ï¼ˆè·³è¿‡æ…¢é€Ÿæµ‹è¯•ï¼‰
python run_tests.py --fast

# å¹¶è¡Œæµ‹è¯•
python run_tests.py --parallel
```

### 8.3 å¸¸è§é—®é¢˜è§£å†³

**Q: JWTä»¤ç‰ŒéªŒè¯å¤±è´¥ï¼Ÿ**
A: æ£€æŸ¥JWT_SECRETé…ç½®ï¼Œç¡®ä¿ç”¨æˆ·ä¸Šä¸‹æ–‡å·²åˆ›å»º

**Q: Redisè¿æ¥é”™è¯¯ï¼Ÿ**
A: ç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§åˆ°å†…å­˜æ¨¡å¼ï¼Œæ£€æŸ¥RedisæœåŠ¡çŠ¶æ€

**Q: è¿æ¥æ± é”™è¯¯ï¼Ÿ**
A: ç¡®ä¿å¼‚æ­¥ä¸Šä¸‹æ–‡æ­£ç¡®åˆå§‹åŒ–ï¼Œæ£€æŸ¥äº‹ä»¶å¾ªç¯çŠ¶æ€

**Q: æµ‹è¯•å¤±è´¥ï¼Ÿ**
A: æ£€æŸ¥ä¾èµ–åŒ…å®‰è£…ï¼Œç¡®è®¤æµ‹è¯•ç¯å¢ƒé…ç½®æ­£ç¡®

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-07-31
**ç‰ˆæœ¬**: 1.0.0
**å®¡æ ¸äººå‘˜**: Testing Specialist & Senior QA Engineer
**ç³»ç»ŸçŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª